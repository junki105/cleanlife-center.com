window.BWU=window.BWU||{},window.BWU.Restore=window.BWU.Restore||{},window.BWU.Restore.Factory=window.BWU.Restore.Factory||{},function(u,t,e,n,p,r,o){"use strict";function i(t,e){var n=u.Restore.FactoryDatabase(this.url,this.nonce,JSON.stringify({dbhost:document.querySelector("#db_host").value.trim(),dbname:document.querySelector("#db_name").value.trim(),dbuser:document.querySelector("#db_user").value.trim(),dbpassword:document.querySelector("#db_pw").value.trim(),dbcharset:document.querySelector("#db_charset").value.trim()}));t?p.isFunction(e)&&n.saveConnectionSettings(e):n.testConnection()}function s(t){this.decrypter.needDecryption(t.state)}function d(t){return t.preventDefault(),u.Restore.Functions.loadNextStep(parseInt(t.currentTarget.getAttribute("data-next-step"),10),this.nonce),this}function a(){r(".step-loader:not(#db_form_continue_btn)").on("click",d.bind(this)),r("#submit_decrypt_key").on("click",function(){this.decrypter.decrypt({backwpup_action_nonce:this.nonce,encrypted_file_path:this.urlParser("?restore_file")})}.bind(this)),r("body").on(this.ACTION_UPLOAD_SUCCESS,function(){r(".restore-progress-container .progressbar").fadeIn(function(){this.decompresser.decompress()}.bind(this))}.bind(this)),this.downloader&&(r("body").on(this.downloader.ACTION_DOWNLOAD_REQUIRE_DECRYPTION,s.bind(this)),r("body").on(this.downloader.ACTION_DOWNLOAD_SUCCESS,this.decompresser.decompress)),r("body").on(this.decrypter.ACTION_DECRYPTION_SUCCESS,this.decompresser.decompress),r("body").on(this.decompresser.ACTION_DECOMPRESS_FAILED,s.bind(this)),r("body").on(this.decompresser.ACTION_DECOMPRESS_SUCCESS,function(){u.Restore.Functions.loadNextStep(2,this.nonce)}.bind(this))}var h={step1:function(){return this.downloader&&function(){if(!this.urlParser("?trigger_download"))return!1;r(this.uploadElement).hide(),r("#upload_progress").text(o.downloadingArchive),r(".restore-progress-container .progressbar").fadeIn(),this.downloader.download()}.call(this),function(){return this.uploader=new this.uploader.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:"plupload-browse-button",drop_element:"drag-drop-area",multi_selection:!1,url:this.url+"?action=upload&backwpup_action_nonce="+this.nonce,chunk_size:"2mb",filters:{max_file_size:"0",mime_types:[{title:"Zip files",extensions:"zip,tar,tar.gz,tar.bz2,sql,sql.gz"}]},flash_swf_url:"components/moxie/bin/flash/Moxie.swf",silverlight_xap_url:"components/moxie/bin/silverlight/Moxie.xap",id:"restore",init:{FilesAdded:function(){r(this.uploadElement).hide(),this.uploader.start()}.bind(this),UploadProgress:function(t,e){r("#upload_progress").text(o.uploadingArchive+e.percent+"%")},FileUploaded:function(t,e){-1===e.name.indexOf(".sql")&&r("body").trigger(this.ACTION_UPLOAD_SUCCESS,t,e)}.bind(this),Error:function(t,e){u.Functions.printMessageError(e.message,r("#restore_step")),r("body").trigger(this.ACTION_UPLOAD_FAILED,t,e)}}}),this.uploader.init(),this}.call(this),r(this.uploadElement).on("dragover",function(){r(this.uploadElement).addClass("drag-drop-active")}.bind(this)).on("dragleave",function(){r(this.uploadElement).removeClass("drag-drop-active")}.bind(this)).on("drop",function(){r(this.uploadElement).removeClass("drag-drop-active")}.bind(this)),this},step2:function(){return r(".restore-select-strategy").on("click",function(t){t.preventDefault(),this.strategy.save(t.currentTarget.getAttribute("data-strategy"))}.bind(this)),this},step3:function(){var e=this;return r("#db_edit_btn").on("click",function(t){t.preventDefault(),r("#db-settings-form").find("input").removeAttr("readonly"),r("#db_host").focus()}),r("#db_test_btn").on("click",function(t){t.preventDefault(),i.call(e,!1)}),r("#db_form_continue_btn").on("click",function(t){t.preventDefault(),i.call(e,!0,function(){d.call(e,t)})}),this},step4:function(){return r("#start-restore").on("click",function(t){var e=this;t.preventDefault(),this.strategy.retrieve(function(t){"complete restore"!==t.data.message?"db only restore"===t.data.message&&e.databaserestore.init().restore():e.filesrestore.init().restore()})}.bind(this)),this},init:function(){return a.call(this),this},construct:function(t,e,n,r,o,i,s,d,a,c,l){return p.bindAll(this,"step1","step2","step3","step4","init"),this.url=t,this.nonce=e,this.urlParser=n,this.uploadElement=o,this.uploader=r,this.strategy=i,this.databaserestore=s,this.filesrestore=d,this.decompresser=a,this.downloader=c,this.decrypter=l,this}};u.Restore.FactoryController=function(t,e,n,r,o,i,s,d,a,c,l){return Object.create(h,{ACTION_UPLOAD_SUCCESS:u.Functions.makeConstant("backwpup.upload_success"),ACTION_UPLOAD_FAILED:u.Functions.makeConstant("backwpup.upload_error")}).construct(t,e,n,r,o,i,s,d,a,c,l)}}(window.BWU,window.ajaxurl,window.url,window.plupload,window._,window.jQuery,window.backwpupRestoreLocalized);