!function(i,r,a,s,n){function t(e){return{value:e,writable:!1,configurable:!1,enumerable:!1}}function c(){return document.querySelector("#backwpupajaxnonce").value}function y(e){var t=document.querySelector("#asymmetric_key_generation_waiting");t&&(t.style.display=e)}function o(){var e=document.querySelector("#bwu_encrypt_notice");e&&e.remove()}function l(e,t,i){o(),i&&i.insertAdjacentHTML("beforebegin",'<div id="bwu_encrypt_notice" class="notice notice-'+t+'"><p>'+e+"</p></div>")}var m={generateSymmetricKey:function(e){var t,i,a;this.disableSaveSettings(),e.preventDefault(),e.stopPropagation(),a={action:"encrypt_key_handler",task:"generate_symmetric_key",_ajax_nonce:c()},t=function(e){var t=e.data;e.success?(r(this.symmetricKeyGenerator).hide(),r(this.symmetricKeyDownloader).show(),this.symmetricKeyField.value=t.key,this.symmetricKey.innerText=t.key,this.symmetricKeyDownloader.setAttribute("href","data:application/octet-stream;charset=utf-16le;base64,"+btoa(t.key)),l(t.message,"success",document.querySelector(".nav-tab-wrapper"))):l(t.message,"error",document.querySelector(".nav-tab-wrapper"))}.bind(this),i=function(e,t,i){l(i,"error",document.querySelector(".nav-tab-wrapper"))}.bind(this),r.post(s,a,t).fail(i)},generateAsymmetricKey:function(e){var t,i,a;this.disableSaveSettings(),e.preventDefault(),y("block"),t={action:"encrypt_key_handler",task:"generate_asymmetric_key_pair",_ajax_nonce:c()},i=function(e){var t,i,a=e.data,r=a.keys.publicKey,s=a.keys.privateKey;this.generatedKeyContainer&&(e.success?(t=this.generatedKeyContainer.querySelector("#asymmetric_generated_public_key_downloader"),i=this.generatedKeyContainer.querySelector("#asymmetric_generated_private_key_downloader"),t&&i&&(this.generatedKeyContainer.querySelector(".bwu-generated-key__public .bwu-the-key").innerText=r,this.generatedKeyContainer.querySelector(".bwu-generated-key__private .bwu-the-key").innerText=s,t.setAttribute("href","data:text/plain;base64,"+btoa(r)),i.setAttribute("href","data:text/plain;base64,"+btoa(s)),y("none"),this.asymmetricModal.style.display="block",l(a.message,"success",this.asymmetricModal))):l(a.message,"error",this.asymmetricModal))}.bind(this),a=function(e,t,i){l(i,"error",this.asymmetricModal)}.bind(this),r.post(s,t,i).fail(a)},asymmetricPublicKeyValueToField:function(e){var t=this.generatedKeyContainer.querySelector(".bwu-generated-key__public .bwu-the-key").innerHTML;e.preventDefault(),e.stopImmediatePropagation(),this.keyHasBeenDownloaded?(this.asymmetricPublicKeyField.setAttribute("value",t),this.asymmetricPublicKey.innerHTML=t,a(),this.enableSaveSettings()):alert(n.mustDownloadPrivateKey)},validateAsymmetricKeysModal:function(e){e.preventDefault(),o(),this.asymmetricPublicKeyField.value||l(n.publicKeyMissed,"warning",this.asymmetricValidateModal)},validateAsymmetricKey:function(){var e,t,i;if(!this.asymmetricPrivateKeyField.value)return alert(n.privateKeyMissed),!1;e={action:"encrypt_key_handler",task:"validate_asymmetric_key_pair",publickey:this.asymmetricPublicKeyField.value,privatekey:this.asymmetricPrivateKeyField.value,_ajax_nonce:c()},t=function(e){var t;t=e.data,e.success||l(t.message,"error",this.asymmetricValidateModal),t.valid?l(n.validPublicKey,"success",this.asymmetricValidateModal):l(n.invalidPublicKey,"error",this.asymmetricValidateModal)}.bind(this),i=function(e,t,i){l(i,"error",this.asymmetricValidateModal)},r.post(s,e,t).fail(i)},cleanOnThickBoxClosing:function(){this.asymmetricModal.style.display="none",this.asymmetricPrivateKeyField.value=""},toggleEncryptionType:function(e){var t,i;switch(e.target.value){case this.TYPE_SYMMETRIC:t="symmetric",i="asymmetric";break;case this.TYPE_ASYMMETRIC:t="asymmetric",i="symmetric"}r(this.tab.querySelector("#"+t+"_key_container")).show(),r(this.tab.querySelector("#"+i+"_key_container")).hide(),this.enableSaveSettings()},currentOption:function(){return i.filter(this.encryptionKeyOptions,function(e){return e.checked})[0]},ensureDownloadedKeys:function(e){var t;if(r(this.tab).is(":visible"))if(this.keyHasBeenDownloaded)this.disableSaveSettings();else{switch(e.preventDefault(),this.currentOption().value){case this.TYPE_SYMMETRIC:t=n.mustDownloadSymmetricKey;break;case this.TYPE_ASYMMETRIC:t=n.mustDownloadPrivateKey}l(t,"error",document.querySelector(".nav-tab-wrapper"))}},enableSaveSettings:function(){this.keyHasBeenDownloaded=!0},disableSaveSettings:function(){this.keyHasBeenDownloaded=!1},construct:function(){var e,t;return i.bindAll(this,"toggleEncryptionType","addListeners","generateSymmetricKey","generateAsymmetricKey","asymmetricPublicKeyValueToField","validateAsymmetricKeysModal","cleanOnThickBoxClosing","validateAsymmetricKey","ensureDownloadedKeys","enableSaveSettings","disableSaveSettings","init"),!!(e=document.querySelector("#backwpup-tab-encryption"))&&(!!(t=e.querySelectorAll(".bwu-encryption-input")).length&&(this.form=document.querySelector("#settingsform"),this.tab=e,this.encryptionKeyOptions=t,this.symmetricKey=this.tab.querySelector("#symmetric_key_code"),this.symmetricKeyField=this.tab.querySelector("#symmetric_key"),this.symmetricKeyDownloader=this.tab.querySelector("#symmetric_key_downloader"),this.asymmetricPublicKey=this.tab.querySelector("#asymmetric_public_key_code"),this.asymmetricPublicKeyField=this.tab.querySelector("#asymmetric_public_key"),this.symmetricKeyGenerator=this.tab.querySelector("#symmetric_key_generator"),this.asymmetricKeyGenerator=this.tab.querySelector("#asymmetric_key_pair_generator"),this.asymmetricKeyOpenValidateModal=this.tab.querySelector("#asymmetric_key_open_validate_modal"),this.asymmetricModal=document.querySelector("#asymmetric_generated_key_modal"),this.generatedKeyContainer=this.asymmetricModal.querySelector(".bwu-generated-key"),this.privateKeyDownloader=this.asymmetricModal.querySelector("#asymmetric_generated_private_key_downloader"),this.asymmetricKeySelector=this.asymmetricModal.querySelector("#asymmetric_keys_selector"),this.keyHasBeenDownloaded=!0,this.asymmetricValidateModal=document.querySelector("#asymmetric_key_pair_validate"),this.asymmetricKeyDoValidation=this.asymmetricValidateModal.querySelector("#asymmetric_key_pair_do_validation"),this.asymmetricPrivateKeyField=this.asymmetricValidateModal.querySelector("#private_key_validate_area"),this))},addListeners:function(){i.each(this.encryptionKeyOptions,function(e){e.addEventListener("change",this.toggleEncryptionType)}.bind(this)),this.symmetricKeyGenerator.addEventListener("click",this.generateSymmetricKey),this.asymmetricKeyGenerator.addEventListener("click",this.generateAsymmetricKey),this.symmetricKeyDownloader.addEventListener("click",this.enableSaveSettings),this.privateKeyDownloader.addEventListener("click",this.enableSaveSettings),this.asymmetricKeySelector.addEventListener("click",this.asymmetricPublicKeyValueToField),this.asymmetricKeyOpenValidateModal.addEventListener("click",this.validateAsymmetricKeysModal),this.asymmetricKeyDoValidation.addEventListener("click",this.validateAsymmetricKey),this.form.addEventListener("submit",this.ensureDownloadedKeys),r("body").on("thickbox:removed",this.cleanOnThickBoxClosing)},init:function(){this.toggleEncryptionType({target:this.currentOption()}),this.addListeners()}};window.addEventListener("load",function(){var e=Object.create(m,{TYPE_ASYMMETRIC:t("asymmetric"),TYPE_SYMMETRIC:t("symmetric")});e.construct()&&e.init()})}(window._,window.jQuery,window.tb_remove,window.ajaxurl,window.settingsEncryptionVariables);